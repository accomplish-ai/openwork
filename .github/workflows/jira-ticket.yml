name: Jira Ticket Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-jira-ticket:
    name: Jira Ticket Reference
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login != 'dependabot[bot]'
    steps:
      - name: Check for Jira ticket link in PR body
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const JIRA_URL_PATTERN = /https:\/\/accomplish-ai\.atlassian\.net\/browse\/[A-Z][A-Z0-9]+-\d+/g;

            const body = context.payload.pull_request.body || '';
            const matches = body.match(JIRA_URL_PATTERN);

            if (matches && matches.length > 0) {
              const unique = [...new Set(matches)];
              core.info(`Found Jira ticket(s): ${unique.join(', ')}`);
              return;
            }

            core.setFailed(
              `No Jira ticket link found in PR description.\n\n` +
              `Please include a link to the Jira ticket in the PR body, e.g.:\n` +
              `  https://accomplish-ai.atlassian.net/browse/ENG-123\n\n` +
              `This ensures every PR is traceable to a tracked work item.`
            );
