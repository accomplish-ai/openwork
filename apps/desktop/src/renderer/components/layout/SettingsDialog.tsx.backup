'use client';

import { AnimatePresence, motion } from 'framer-motion';
import { useState, useEffect, useCallback } from 'react';
import { settingsVariants, settingsTransitions } from '@/lib/animations';
import { analytics } from '@/lib/analytics';
import { getAccomplish } from '@/lib/accomplish';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
<<<<<<< HEAD
import { Trash2 } from 'lucide-react';
import type { ApiKeyConfig, SelectedModel } from '@accomplish/shared';
import { DEFAULT_PROVIDERS } from '@accomplish/shared';
import logoImage from '/assets/logo.png';
import { useTranslation } from 'react-i18next';
import { changeLanguage } from '@/i18n/config';
=======
import type { ProviderId, ConnectedProvider } from '@accomplish/shared';
import { hasAnyReadyProvider, isProviderReady } from '@accomplish/shared';
import { useProviderSettings } from '@/components/settings/hooks/useProviderSettings';
import { ProviderGrid } from '@/components/settings/ProviderGrid';
import { ProviderSettingsPanel } from '@/components/settings/ProviderSettingsPanel';

// First 4 providers shown in collapsed view (matches PROVIDER_ORDER in ProviderGrid)
const FIRST_FOUR_PROVIDERS: ProviderId[] = ['anthropic', 'openai', 'google', 'bedrock'];
>>>>>>> upstream/main

interface SettingsDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onApiKeySaved?: () => void;
}

export default function SettingsDialog({ open, onOpenChange, onApiKeySaved }: SettingsDialogProps) {
<<<<<<< HEAD
  const { t, i18n } = useTranslation();
  const [apiKey, setApiKey] = useState('');
  const [provider, setProvider] = useState<ProviderId>('anthropic');
  const [isSaving, setIsSaving] = useState(false);
  const [statusMessage, setStatusMessage] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [savedKeys, setSavedKeys] = useState<ApiKeyConfig[]>([]);
  const [loadingKeys, setLoadingKeys] = useState(true);
  const [debugMode, setDebugMode] = useState(false);
  const [loadingDebug, setLoadingDebug] = useState(true);
  const [appVersion, setAppVersion] = useState('');
  const [selectedModel, setSelectedModel] = useState<SelectedModel | null>(null);
  const [loadingModel, setLoadingModel] = useState(true);
  const [modelStatusMessage, setModelStatusMessage] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'cloud' | 'local' | 'proxy'>('cloud');
  const [ollamaUrl, setOllamaUrl] = useState('http://localhost:11434');
  const [ollamaModels, setOllamaModels] = useState<Array<{ id: string; displayName: string; size: number }>>([]);
  const [ollamaConnected, setOllamaConnected] = useState(false);
  const [ollamaError, setOllamaError] = useState<string | null>(null);
  const [testingOllama, setTestingOllama] = useState(false);
  const [selectedOllamaModel, setSelectedOllamaModel] = useState<string>('');
  const [savingOllama, setSavingOllama] = useState(false);
  const [keyToDelete, setKeyToDelete] = useState<string | null>(null);
  const [bedrockAuthTab, setBedrockAuthTab] = useState<'accessKeys' | 'profile'>('accessKeys');
  const [bedrockAccessKeyId, setBedrockAccessKeyId] = useState('');
  const [bedrockSecretKey, setBedrockSecretKey] = useState('');
  const [bedrockSessionToken, setBedrockSessionToken] = useState('');
  const [bedrockProfileName, setBedrockProfileName] = useState('default');
  const [bedrockRegion, setBedrockRegion] = useState('us-east-1');
  const [savingBedrock, setSavingBedrock] = useState(false);
  const [bedrockError, setBedrockError] = useState<string | null>(null);
  const [bedrockStatus, setBedrockStatus] = useState<string | null>(null);
=======
  const [selectedProvider, setSelectedProvider] = useState<ProviderId | null>(null);
  const [gridExpanded, setGridExpanded] = useState(false);
  const [closeWarning, setCloseWarning] = useState(false);
  const [showModelError, setShowModelError] = useState(false);
>>>>>>> upstream/main

  const {
    settings,
    loading,
    setActiveProvider,
    connectProvider,
    disconnectProvider,
    updateModel,
    refetch,
  } = useProviderSettings();

<<<<<<< HEAD
  // LiteLLM state
  const [litellmUrl, setLitellmUrl] = useState('http://localhost:4000');
  const [litellmApiKey, setLitellmApiKey] = useState('');
  const [litellmModels, setLitellmModels] = useState<Array<{ id: string; name: string; provider: string; contextLength: number }>>([]);
  const [litellmConnected, setLitellmConnected] = useState(false);
  const [litellmError, setLitellmError] = useState<string | null>(null);
  const [testingLitellm, setTestingLitellm] = useState(false);
  const [selectedLitellmModel, setSelectedLitellmModel] = useState<string>('');
  const [savingLitellm, setSavingLitellm] = useState(false);
  const [litellmSearch, setLitellmSearch] = useState('');

  // Language state
  const [currentLanguage, setCurrentLanguage] = useState(i18n.language);
  const [supportedLocales, setSupportedLocales] = useState<string[]>([]);

  // Sync selectedProxyPlatform and selected model radio button with the actual selected model
  useEffect(() => {
    if (selectedModel?.provider === 'litellm') {
      setSelectedProxyPlatform('litellm');
      // Extract model ID from "litellm/anthropic/claude-haiku" -> "anthropic/claude-haiku"
      const modelId = selectedModel.model?.replace(/^litellm\//, '') || '';
      if (modelId) {
        setSelectedLitellmModel(modelId);
      }
    } else if (selectedModel?.provider === 'openrouter') {
      setSelectedProxyPlatform('openrouter');
      // Extract model ID from "openrouter/anthropic/..." -> "anthropic/..."
      const modelId = selectedModel.model?.replace(/^openrouter\//, '') || '';
      if (modelId) {
        setSelectedOpenrouterModel(modelId);
      }
    }
  }, [selectedModel]);
=======
  // Debug mode state - stored in appSettings, not providerSettings
  const [debugMode, setDebugModeState] = useState(false);
  const accomplish = getAccomplish();
>>>>>>> upstream/main

  // Refetch settings and debug mode when dialog opens
  useEffect(() => {
    if (!open) return;
    refetch();
    // Load debug mode from appSettings (correct store)
    accomplish.getDebugMode().then(setDebugModeState);
  }, [open, refetch, accomplish]);

  // Auto-select active provider and expand grid if needed when dialog opens
  useEffect(() => {
    if (!open || loading || !settings?.activeProviderId) return;

    // Auto-select the active provider to show its connection details immediately
    setSelectedProvider(settings.activeProviderId);

    // Auto-expand grid if active provider is not in the first 4 visible providers
    if (!FIRST_FOUR_PROVIDERS.includes(settings.activeProviderId)) {
      setGridExpanded(true);
    }
  }, [open, loading, settings?.activeProviderId]);

<<<<<<< HEAD
    const fetchVersion = async () => {
      try {
        const version = await accomplish.getVersion();
        setAppVersion(version);
      } catch (err) {
        console.error('Failed to fetch version:', err);
      }
    };

    const fetchSelectedModel = async () => {
      try {
        const model = await accomplish.getSelectedModel();
        setSelectedModel(model as SelectedModel | null);
      } catch (err) {
        console.error('Failed to fetch selected model:', err);
      } finally {
        setLoadingModel(false);
      }
    };

    const fetchOllamaConfig = async () => {
      try {
        const config = await accomplish.getOllamaConfig();
        if (config) {
          setOllamaUrl(config.baseUrl);
          // Auto-test connection if previously configured
          if (config.enabled) {
            const result = await accomplish.testOllamaConnection(config.baseUrl);
            if (result.success && result.models) {
              setOllamaConnected(true);
              setOllamaModels(result.models);
            }
          }
        }
      } catch (err) {
        console.error('Failed to fetch Ollama config:', err);
      }
    };

    const fetchBedrockCredentials = async () => {
      try {
        const credentials = await accomplish.getBedrockCredentials();
        if (credentials) {
          setBedrockAuthTab(credentials.authType);
          if (credentials.authType === 'accessKeys') {
            setBedrockAccessKeyId(credentials.accessKeyId || '');
            // Don't pre-fill secret key for security
          } else {
            setBedrockProfileName(credentials.profileName || 'default');
          }
          setBedrockRegion(credentials.region || 'us-east-1');
        }
      } catch (err) {
        console.error('Failed to fetch Bedrock credentials:', err);
      }
    };

    const fetchLiteLLMConfig = async () => {
      try {
        const config = await accomplish.getLiteLLMConfig();
        if (config) {
          setLitellmUrl(config.baseUrl);
          // Auto-reconnect if previously configured - uses stored API key from secure storage
          if (config.enabled) {
            const result = await accomplish.fetchLiteLLMModels();
            if (result.success && result.models) {
              setLitellmConnected(true);
              setLitellmModels(result.models);
            }
          }
        }
      } catch (err) {
        console.error('Failed to fetch LiteLLM config:', err);
      }
    };

    const fetchSupportedLocales = async () => {
      try {
        const locales = await accomplish.getSupportedLocales();
        setSupportedLocales(locales);
      } catch (err) {
        console.error('Failed to fetch supported locales:', err);
      }
    };

    fetchKeys();
    fetchDebugSetting();
    fetchVersion();
    fetchSelectedModel();
    fetchOllamaConfig();
    fetchBedrockCredentials();
    fetchLiteLLMConfig();
    fetchSupportedLocales();
=======
  // Reset state when dialog closes
  useEffect(() => {
    if (!open) {
      setSelectedProvider(null);
      setGridExpanded(false);
      setCloseWarning(false);
      setShowModelError(false);
    }
>>>>>>> upstream/main
  }, [open]);

  // Handle close attempt
  const handleOpenChange = useCallback((newOpen: boolean) => {
    if (!newOpen && settings) {
      // Check if user is trying to close
      if (!hasAnyReadyProvider(settings)) {
        // No ready provider - show warning
        setCloseWarning(true);
        return;
      }
    }
    setCloseWarning(false);
    onOpenChange(newOpen);
  }, [settings, onOpenChange]);

  // Handle provider selection
  const handleSelectProvider = useCallback(async (providerId: ProviderId) => {
    setSelectedProvider(providerId);
    setCloseWarning(false);
    setShowModelError(false);

    // Auto-set as active if the selected provider is ready
    const provider = settings?.connectedProviders?.[providerId];
    if (provider && isProviderReady(provider)) {
      await setActiveProvider(providerId);
    }
  }, [settings?.connectedProviders, setActiveProvider]);

  // Handle provider connection
  const handleConnect = useCallback(async (provider: ConnectedProvider) => {
    await connectProvider(provider.providerId, provider);
    analytics.trackSaveApiKey(provider.providerId);

    // Auto-set as active if the new provider is ready (connected + has model selected)
    // This ensures newly connected ready providers become active, regardless of
    // whether another provider was already active
    if (isProviderReady(provider)) {
      await setActiveProvider(provider.providerId);
      onApiKeySaved?.();
    }
  }, [connectProvider, setActiveProvider, onApiKeySaved]);

  // Handle provider disconnection
  const handleDisconnect = useCallback(async () => {
    if (!selectedProvider) return;
    const wasActiveProvider = settings?.activeProviderId === selectedProvider;
    await disconnectProvider(selectedProvider);
    setSelectedProvider(null);

    // If we just removed the active provider, auto-select another ready provider
    if (wasActiveProvider && settings?.connectedProviders) {
      const readyProviderId = Object.keys(settings.connectedProviders).find(
        (id) => id !== selectedProvider && isProviderReady(settings.connectedProviders[id as ProviderId])
      ) as ProviderId | undefined;
      if (readyProviderId) {
        await setActiveProvider(readyProviderId);
      }
    }
  }, [selectedProvider, disconnectProvider, settings?.activeProviderId, settings?.connectedProviders, setActiveProvider]);

  // Handle model change
  const handleModelChange = useCallback(async (modelId: string) => {
    if (!selectedProvider) return;
    await updateModel(selectedProvider, modelId);
    analytics.trackSelectModel(modelId);

    // Auto-set as active if this provider is now ready
    const provider = settings?.connectedProviders[selectedProvider];
    if (provider && isProviderReady({ ...provider, selectedModelId: modelId })) {
      if (!settings?.activeProviderId || settings.activeProviderId !== selectedProvider) {
        await setActiveProvider(selectedProvider);
      }
    }

    setShowModelError(false);
    onApiKeySaved?.();
  }, [selectedProvider, updateModel, settings, setActiveProvider, onApiKeySaved]);

  // Handle debug mode toggle - writes to appSettings (correct store)
  const handleDebugToggle = useCallback(async () => {
    const newValue = !debugMode;
    await accomplish.setDebugMode(newValue);
    setDebugModeState(newValue);
    analytics.trackToggleDebugMode(newValue);
  }, [debugMode, accomplish]);

<<<<<<< HEAD
  const handleLanguageChange = async (locale: string) => {
    const accomplish = getAccomplish();
    try {
      await changeLanguage(locale);
      await accomplish.setLocale(locale);
      setCurrentLanguage(locale);
    } catch (err) {
      console.error('Failed to change language:', err);
    }
  };

  const handleModelChange = async (fullId: string) => {
    const accomplish = getAccomplish();
    const allModels = DEFAULT_PROVIDERS.flatMap((p) => p.models);
    const model = allModels.find((m) => m.fullId === fullId);
    if (model) {
      analytics.trackSelectModel(model.displayName);
      const newSelection: SelectedModel = {
        provider: model.provider,
        model: model.fullId,
      };
      setModelStatusMessage(null);
      try {
        await accomplish.setSelectedModel(newSelection);
        setSelectedModel(newSelection);
        setModelStatusMessage(`Model updated to ${model.displayName}`);
      } catch (err) {
        console.error('Failed to save model selection:', err);
      }
    }
  };
=======
  // Handle done button (close with validation)
  const handleDone = useCallback(() => {
    if (!settings) return;
>>>>>>> upstream/main

    // Check if selected provider needs a model
    if (selectedProvider) {
      const provider = settings.connectedProviders[selectedProvider];
      if (provider?.connectionStatus === 'connected' && !provider.selectedModelId) {
        setShowModelError(true);
        return;
      }
    }

    // Check if any provider is ready
    if (!hasAnyReadyProvider(settings)) {
      setCloseWarning(true);
      return;
    }

    // Validate active provider is still connected and ready
    // This handles the case where the active provider was removed
    if (settings.activeProviderId) {
      const activeProvider = settings.connectedProviders[settings.activeProviderId];
      if (!isProviderReady(activeProvider)) {
        // Active provider is no longer ready - find a ready provider to set as active
        const readyProviderId = Object.keys(settings.connectedProviders).find(
          (id) => isProviderReady(settings.connectedProviders[id as ProviderId])
        ) as ProviderId | undefined;
        if (readyProviderId) {
          setActiveProvider(readyProviderId);
        }
      }
    } else {
      // No active provider set - auto-select first ready provider
      const readyProviderId = Object.keys(settings.connectedProviders).find(
        (id) => isProviderReady(settings.connectedProviders[id as ProviderId])
      ) as ProviderId | undefined;
      if (readyProviderId) {
        setActiveProvider(readyProviderId);
      }
    }

    onOpenChange(false);
  }, [settings, selectedProvider, onOpenChange, setActiveProvider]);

  // Force close (dismiss warning)
  const handleForceClose = useCallback(() => {
    setCloseWarning(false);
    onOpenChange(false);
  }, [onOpenChange]);

  if (loading || !settings) {
    return (
      <Dialog open={open} onOpenChange={handleOpenChange}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto" data-testid="settings-dialog">
          <DialogHeader>
            <DialogTitle>Set up Openwork</DialogTitle>
          </DialogHeader>
          <div className="flex items-center justify-center py-12">
            <div className="h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent" />
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto" data-testid="settings-dialog">
        <DialogHeader>
<<<<<<< HEAD
          <DialogTitle>{t('settings.title')}</DialogTitle>
        </DialogHeader>

        <div className="space-y-8 mt-4">
          {/* Model Selection Section */}
          <section>
            <h2 className="mb-4 text-base font-medium text-foreground">{t('settings.model.title')}</h2>
            <div className="rounded-lg border border-border bg-card p-5">
              {/* Tabs */}
              <div className="flex gap-2 mb-5">
                <button
                  onClick={() => setActiveTab('cloud')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'cloud'
                      ? 'bg-primary text-primary-foreground'
                      : 'bg-muted text-muted-foreground hover:text-foreground'
                    }`}
                >
                  Cloud Providers
                </button>
                <button
                  onClick={() => setActiveTab('local')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'local'
                      ? 'bg-primary text-primary-foreground'
                      : 'bg-muted text-muted-foreground hover:text-foreground'
                    }`}
                >
                  Local Models
                </button>
                <button
                  onClick={() => setActiveTab('proxy')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'proxy'
                      ? 'bg-primary text-primary-foreground'
                      : 'bg-muted text-muted-foreground hover:text-foreground'
                    }`}
                >
                  Proxy Platforms
                </button>
              </div>

              {activeTab === 'cloud' && (
                <>
                  <p className="mb-4 text-sm text-muted-foreground leading-relaxed">
                    Select a cloud AI model. Requires an API key for the provider.
                  </p>
                  {loadingModel ? (
                    <div className="h-10 animate-pulse rounded-md bg-muted" />
                  ) : (
                    <select
                      data-testid="settings-model-select"
                      value={selectedModel?.provider !== 'ollama' ? selectedModel?.model || '' : ''}
                      onChange={(e) => handleModelChange(e.target.value)}
                      className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    >
                      <option value="" disabled>Select a model...</option>
                      {DEFAULT_PROVIDERS.filter((p) => p.requiresApiKey || p.id === 'bedrock').map((provider) => {
                        const hasApiKey = provider.id === 'bedrock'
                          ? savedKeys.some((k) => k.provider === 'bedrock')
                          : savedKeys.some((k) => k.provider === provider.id);
                        return (
                          <optgroup key={provider.id} label={provider.name}>
                            {provider.models.map((model) => (
                              <option
                                key={model.fullId}
                                value={model.fullId}
                                disabled={!hasApiKey}
                              >
                                {model.displayName}{!hasApiKey ? ' (No API key)' : ''}
                              </option>
                            ))}
                          </optgroup>
                        );
                      })}
                    </select>
                  )}
                  {modelStatusMessage && (
                    <p className="mt-3 text-sm text-success">{modelStatusMessage}</p>
                  )}
                  {selectedModel && selectedModel.provider !== 'ollama' && !savedKeys.some((k) => k.provider === selectedModel.provider) && (
                    <p className="mt-3 text-sm text-warning">
                      No API key configured for {DEFAULT_PROVIDERS.find((p) => p.id === selectedModel.provider)?.name}. Add one below.
=======
          <DialogTitle>Set up Openwork</DialogTitle>
        </DialogHeader>

        <div className="space-y-6 mt-4">
          {/* Close Warning */}
          <AnimatePresence>
            {closeWarning && (
              <motion.div
                className="rounded-lg border border-warning bg-warning/10 p-4"
                variants={settingsVariants.fadeSlide}
                initial="initial"
                animate="animate"
                exit="exit"
                transition={settingsTransitions.enter}
              >
                <div className="flex items-start gap-3">
                  <svg className="h-5 w-5 text-warning flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <div className="flex-1">
                    <p className="text-sm font-medium text-warning">No provider ready</p>
                    <p className="mt-1 text-sm text-muted-foreground">
                      You need to connect a provider and select a model before you can run tasks.
>>>>>>> upstream/main
                    </p>
                    <div className="mt-3 flex gap-2">
                      <button
                        onClick={handleForceClose}
                        className="rounded-md px-3 py-1.5 text-sm font-medium bg-muted text-muted-foreground hover:bg-muted/80"
                      >
                        Close Anyway
                      </button>
                    </div>
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Provider Grid Section */}
          <section>
            <ProviderGrid
              settings={settings}
              selectedProvider={selectedProvider}
              onSelectProvider={handleSelectProvider}
              expanded={gridExpanded}
              onToggleExpanded={() => setGridExpanded(!gridExpanded)}
            />
          </section>

<<<<<<< HEAD
          {/* API Key Section - Only show for cloud providers */}
          {activeTab === 'cloud' && (
            <section>
              <h2 className="mb-4 text-base font-medium text-foreground">{t('settings.apiKeys.title')}</h2>
              <div className="rounded-lg border border-border bg-card p-5">
                <p className="mb-5 text-sm text-muted-foreground leading-relaxed">
                  {t('settings.apiKeys.description')}
                </p>

                {/* Provider Selection */}
                <div className="mb-5">
                  <label className="mb-2.5 block text-sm font-medium text-foreground">
                    Provider
                  </label>
                  <div className="grid grid-cols-2 gap-3">
                    {API_KEY_PROVIDERS.map((p) => (
                      <button
                        key={p.id}
                        onClick={() => {
                          analytics.trackSelectProvider(p.name);
                          setProvider(p.id);
                        }}
                        className={`rounded-xl border p-4 text-center transition-all duration-200 ease-accomplish ${provider === p.id
                            ? 'border-primary bg-muted'
                            : 'border-border hover:border-ring'
                          }`}
                      >
                        <div className="font-medium text-foreground">{p.name}</div>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Bedrock Credentials Form */}
                {provider === 'bedrock' && (
                  <div className="mb-5">
                    {/* Auth Type Tabs */}
                    <div className="flex gap-2 mb-4">
                      <button
                        onClick={() => setBedrockAuthTab('accessKeys')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${bedrockAuthTab === 'accessKeys'
                            ? 'bg-primary text-primary-foreground'
                            : 'bg-muted text-muted-foreground hover:text-foreground'
                          }`}
                      >
                        Access Keys
                      </button>
                      <button
                        onClick={() => setBedrockAuthTab('profile')}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${bedrockAuthTab === 'profile'
                            ? 'bg-primary text-primary-foreground'
                            : 'bg-muted text-muted-foreground hover:text-foreground'
                          }`}
                      >
                        AWS Profile
                      </button>
                    </div>

                    {bedrockAuthTab === 'accessKeys' ? (
                      <>
                        <div className="mb-4">
                          <label className="mb-2.5 block text-sm font-medium text-foreground">
                            Access Key ID
                          </label>
                          <input
                            data-testid="bedrock-access-key-input"
                            type="text"
                            value={bedrockAccessKeyId}
                            onChange={(e) => setBedrockAccessKeyId(e.target.value)}
                            placeholder="AKIA..."
                            className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                          />
                        </div>
                        <div className="mb-4">
                          <label className="mb-2.5 block text-sm font-medium text-foreground">
                            Secret Access Key
                          </label>
                          <input
                            data-testid="bedrock-secret-key-input"
                            type="password"
                            value={bedrockSecretKey}
                            onChange={(e) => setBedrockSecretKey(e.target.value)}
                            placeholder="Enter your secret access key"
                            className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                          />
                        </div>
                        <div className="mb-4">
                          <label className="mb-2.5 block text-sm font-medium text-foreground">
                            Session Token <span className="text-muted-foreground">(Optional)</span>
                          </label>
                          <input
                            data-testid="bedrock-session-token-input"
                            type="password"
                            value={bedrockSessionToken}
                            onChange={(e) => setBedrockSessionToken(e.target.value)}
                            placeholder="For temporary credentials (STS)"
                            className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                          />
                        </div>
                      </>
                    ) : (
                      <div className="mb-4">
                        <label className="mb-2.5 block text-sm font-medium text-foreground">
                          Profile Name
                        </label>
                        <input
                          data-testid="bedrock-profile-input"
                          type="text"
                          value={bedrockProfileName}
                          onChange={(e) => setBedrockProfileName(e.target.value)}
                          placeholder="default"
                          className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                      </div>
                    )}

                    <div className="mb-4">
                      <label className="mb-2.5 block text-sm font-medium text-foreground">
                        Region
                      </label>
                      <input
                        data-testid="bedrock-region-input"
                        type="text"
                        value={bedrockRegion}
                        onChange={(e) => setBedrockRegion(e.target.value)}
                        placeholder="us-east-1"
                        className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                      />
                    </div>

                    {bedrockError && <p className="mb-4 text-sm text-destructive">{bedrockError}</p>}
                    {bedrockStatus && <p className="mb-4 text-sm text-success">{bedrockStatus}</p>}

                    <button
                      data-testid="bedrock-save-button"
                      className="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
                      onClick={handleSaveBedrockCredentials}
                      disabled={savingBedrock}
                    >
                      {savingBedrock ? 'Validating...' : 'Save Bedrock Credentials'}
                    </button>
                  </div>
                )}

                {/* API Key Input - hide for Bedrock */}
                {provider !== 'bedrock' && (
                  <div className="mb-5">
                    <label className="mb-2.5 block text-sm font-medium text-foreground">
                      {API_KEY_PROVIDERS.find((p) => p.id === provider)?.name} API Key
                    </label>
                    <input
                      data-testid="settings-api-key-input"
                      type="password"
                      value={apiKey}
                      onChange={(e) => setApiKey(e.target.value)}
                      placeholder={API_KEY_PROVIDERS.find((p) => p.id === provider)?.placeholder}
                      className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                    {provider === 'openrouter' && (
                      <p className="mt-2 text-xs text-muted-foreground">
                        Uses the OpenAI-compatible endpoint at <span className="font-mono">https://openrouter.ai/api/v1</span>. Select an OpenAI model below.
                      </p>
                    )}
                  </div>
                )}

                {provider !== 'bedrock' && error && <p className="mb-4 text-sm text-destructive">{error}</p>}
                {provider !== 'bedrock' && statusMessage && (
                  <p className="mb-4 text-sm text-success">{statusMessage}</p>
                )}

                {provider !== 'bedrock' && (
                  <button
                    className="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
                    onClick={handleSaveApiKey}
                    disabled={isSaving}
                  >
                    {isSaving ? 'Saving...' : 'Save API Key'}
                  </button>
                )}

                {/* Saved Keys */}
                {loadingKeys ? (
                  <div className="mt-6 animate-pulse">
                    <div className="h-4 w-24 rounded bg-muted mb-3" />
                    <div className="h-14 rounded-xl bg-muted" />
                  </div>
                ) : savedKeys.length > 0 && (
                  <div className="mt-6">
                    <h3 className="mb-3 text-sm font-medium text-foreground">Saved Keys</h3>
                    <div className="space-y-2">
                      {savedKeys.map((key) => {
                        const providerConfig = API_KEY_PROVIDERS.find((p) => p.id === key.provider);
                        return (
                          <div
                            key={key.id}
                            className="flex items-center justify-between rounded-xl border border-border bg-muted p-3.5"
                          >
                            <div className="flex items-center gap-3">
                              <div className="flex h-9 w-9 items-center justify-center rounded-lg bg-primary/10">
                                <span className="text-xs font-bold text-primary">
                                  {providerConfig?.name.charAt(0) || key.provider.charAt(0).toUpperCase()}
                                </span>
                              </div>
                              <div>
                                <div className="text-sm font-medium text-foreground">
                                  {providerConfig?.name || key.provider}
                                </div>
                                <div className="text-xs text-muted-foreground font-mono">
                                  {key.keyPrefix}
                                </div>
                              </div>
                            </div>
                            {keyToDelete === key.id ? (
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-muted-foreground">Are you sure?</span>
                                <button
                                  onClick={() => {
                                    handleDeleteApiKey(key.id, key.provider);
                                    setKeyToDelete(null);
                                  }}
                                  className="rounded px-2 py-1 text-xs font-medium bg-destructive text-destructive-foreground hover:bg-destructive/90 transition-colors"
                                >
                                  Yes
                                </button>
                                <button
                                  onClick={() => setKeyToDelete(null)}
                                  className="rounded px-2 py-1 text-xs font-medium bg-muted text-muted-foreground hover:bg-muted/80 transition-colors"
                                >
                                  No
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => setKeyToDelete(key.id)}
                                className="rounded-lg p-2 text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition-colors duration-200 ease-accomplish"
                                title="Remove API key"
                              >
                                <Trash2 className="h-4 w-4" />
                              </button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </section>
          )}

          {/* General Section */}
          <section>
            <h2 className="mb-4 text-base font-medium text-foreground">{t('settings.general.title')}</h2>
            <div className="rounded-lg border border-border bg-card p-5 space-y-5">
              {/* Language Selection */}
              <div>
                <label className="mb-2 block text-sm font-medium text-foreground">
                  {t('settings.general.language')}
                </label>
                <select
                  value={currentLanguage}
                  onChange={(e) => handleLanguageChange(e.target.value)}
                  className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                >
                  {supportedLocales.map((locale) => (
                    <option key={locale} value={locale}>
                      {locale === 'en' && 'English'}
                      {locale === 'zh-CN' && '简体中文'}
                      {locale === 'ja' && '日本語'}
                      {locale === 'ko' && '한국어'}
                      {locale === 'fr' && 'Français'}
                      {locale === 'es' && 'Español'}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </section>

          {/* Developer Section */}
          <section>
            <h2 className="mb-4 text-base font-medium text-foreground">Developer</h2>
            <div className="rounded-lg border border-border bg-card p-5">
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <div className="font-medium text-foreground">Debug Mode</div>
                  <p className="mt-1.5 text-sm text-muted-foreground leading-relaxed">
                    Show detailed backend logs including Claude CLI commands, flags,
                    and stdout/stderr output in the task view.
                  </p>
                </div>
                <div className="ml-4">
                  {loadingDebug ? (
                    <div className="h-6 w-11 animate-pulse rounded-full bg-muted" />
                  ) : (
                    <button
                      data-testid="settings-debug-toggle"
                      onClick={handleDebugToggle}
                      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ease-accomplish ${debugMode ? 'bg-primary' : 'bg-muted'
                        }`}
                    >
                      <span
                        className={`inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform duration-200 ease-accomplish ${debugMode ? 'translate-x-6' : 'translate-x-1'
                          }`}
                      />
                    </button>
                  )}
                </div>
              </div>
              {debugMode && (
                <div className="mt-4 rounded-xl bg-warning/10 p-3.5">
                  <p className="text-sm text-warning">
                    Debug mode is enabled. Backend logs will appear in the task view
                    when running tasks.
                  </p>
                </div>
              )}
            </div>
          </section>

          {/* About Section */}
          <section>
            <h2 className="mb-4 text-base font-medium text-foreground">{t('settings.about.title')}</h2>
            <div className="rounded-lg border border-border bg-card p-5">
              <div className="flex items-center gap-4">
                <img
                  src={logoImage}
                  alt="Openwork"
                  className="h-12 w-12 rounded-xl"
=======
          {/* Provider Settings Panel (shown when a provider is selected) */}
          <AnimatePresence>
            {selectedProvider && (
              <motion.section
                variants={settingsVariants.slideDown}
                initial="initial"
                animate="animate"
                exit="exit"
                transition={settingsTransitions.enter}
              >
                <ProviderSettingsPanel
                  key={selectedProvider}
                  providerId={selectedProvider}
                  connectedProvider={settings?.connectedProviders?.[selectedProvider]}
                  onConnect={handleConnect}
                  onDisconnect={handleDisconnect}
                  onModelChange={handleModelChange}
                  showModelError={showModelError}
>>>>>>> upstream/main
                />
              </motion.section>
            )}
          </AnimatePresence>

          {/* Debug Mode Section - only shown when a provider is selected */}
          <AnimatePresence>
            {selectedProvider && (
              <motion.section
                variants={settingsVariants.slideDown}
                initial="initial"
                animate="animate"
                exit="exit"
                transition={{ ...settingsTransitions.enter, delay: 0.05 }}
              >
                <div className="rounded-lg border border-border bg-card p-5">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="font-medium text-foreground">Debug Mode</div>
                      <p className="mt-1.5 text-sm text-muted-foreground leading-relaxed">
                        Show detailed backend logs in the task view.
                      </p>
                    </div>
                    <div className="ml-4">
                      <button
                        data-testid="settings-debug-toggle"
                        onClick={handleDebugToggle}
                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ease-accomplish ${debugMode ? 'bg-primary' : 'bg-muted'
                          }`}
                      >
                        <span
                          className={`inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform duration-200 ease-accomplish ${debugMode ? 'translate-x-6' : 'translate-x-1'
                            }`}
                        />
                      </button>
                    </div>
                  </div>
                  {debugMode && (
                    <div className="mt-4 rounded-xl bg-warning/10 p-3.5">
                      <p className="text-sm text-warning">
                        Debug mode is enabled. Backend logs will appear in the task view
                        when running tasks.
                      </p>
                    </div>
                  )}
                </div>
              </motion.section>
            )}
          </AnimatePresence>

          {/* Done Button */}
          <div className="flex justify-end">
            <button
              onClick={handleDone}
              className="flex items-center gap-2 rounded-md bg-primary px-6 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
              data-testid="settings-done-button"
            >
              <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
              Done
            </button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
